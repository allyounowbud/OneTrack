<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OneTrack</title>
  <style>
    :root{
      --bg:#0d0d0d; --card:#111; --muted:#777; --text:#e0e0e0; --accent:#66bb6a; --danger:#e57373; --warn:#ffb74d;
      --border:#222; --shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:var(--bg); color:var(--text); }
    a{ color: var(--accent); text-decoration: none; }
    .nav{ display:flex; gap:8px; padding:12px 16px; position:sticky; top:0; background:#0a0a0a; border-bottom:1px solid var(--border); z-index:10; align-items:center; }
    .nav .title{ font-weight:700; margin-right:auto; letter-spacing:.3px; }
    .nav .tab{ padding:8px 12px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:#141414; }
    .nav .tab.active{ border-color:#2a2a2a; background:#171717; outline:1px solid #202020; }
    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px 80px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); margin:16px 0; }
    .card .hd{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); }
    .card .hd h3{ margin:0; font-size:16px; font-weight:700; letter-spacing:.3px; }
    .card .hd .btns{ display:flex; gap:8px; }
    .btn{ padding:8px 12px; background:#1a1a1a; border:1px solid var(--border); border-radius:8px; color:var(--text); cursor:pointer; }
    .btn:hover{ background:#202020; }
    .btn.accent{ border-color:#234; background:#17231a; color:#cfead3; }
    .btn.warn{ border-color:#443; background:#231b17; color:#ffd7b3; }
    .btn.ghost{ background:transparent; }
    .btn.danger{ border-color:#442; background:#261616; color:#ffc7c7; }
    .muted{ color:var(--muted); }
    .body{ padding:14px; display:none; }
    .body.show{ display:block; }
    table{ width:100%; border-collapse:collapse; }
    thead th{ text-align:left; font-size:12px; font-weight:600; color:#bdbdbd; padding:8px; border-bottom:1px solid var(--border); }
    tbody td{ padding:8px; border-bottom:1px solid var(--border); vertical-align:middle; }
    tbody tr.__pending{ background:#121212; }
    td.td-actions{ width:180px; }
    input, select, textarea{
      width:100%; padding:8px 10px; background:#0f0f0f; border:1px solid #222; border-radius:8px; color:#e0e0e0;
    }
    input[type="date"]{ color-scheme: dark; }
    .saved{ outline: 1px solid #1b5e20; transition: outline 300ms ease-in; }
    .pill{ padding:10px 12px; font-size:13px; color:#c7c7c7; }
    .row{ display:flex; gap:14px; flex-wrap:wrap; }
    .col{ flex:1 1 460px; min-width:320px; }
    .hide{ display:none !important; }
    #toast{ position:fixed; bottom:18px; left:50%; transform: translateX(-50%); background:#111; border:1px solid #222; color:#eee; padding:10px 14px; border-radius:10px; box-shadow: var(--shadow); display:none; z-index:1000; }
    #gate{ display:none; max-width:520px; margin:80px auto; text-align:center; }
    #gate .card{ padding:18px; }
    .tag{ display:inline-block; padding:2px 8px; border:1px solid #2a2a2a; border-radius:999px; font-size:12px; color:#bbb; }
    .flex{ display:flex; gap:10px; align-items:center; }
    .right{ margin-left:auto; }
  </style>
</head>
<body>

  <div class="nav">
    <div class="title">Resale Dashboard</div>
    <button class="tab active" data-tab="database">Database</button>
    <button class="tab" data-tab="profiles">Profiles</button>
    <span class="right flex">
      <button id="discordBtn" class="btn accent">Sign in with Discord</button>
      <button id="logoutBtn" class="btn ghost">Logout</button>
    </span>
  </div>

  <div id="gate" class="wrap">
    <div class="card">
      <div class="hd"><h3>Sign in</h3></div>
      <div class="body show">
        <p class="muted">Please sign in to continue.</p>
        <button id="discordBtn_clone" class="btn accent">Sign in with Discord</button>
      </div>
    </div>
  </div>

  <div id="app" class="wrap">

    <!-- Database -->
    <section id="tab_database" class="tabpane">
      <div class="card">
        <div class="hd">
          <h3>Items <span id="db_items_count" class="tag"></span></h3>
          <div class="btns">
            <button class="btn" data-action="edit">Edit</button>
            <button class="btn" data-action="add">Add</button>
            <button class="btn" data-action="save" style="display:none;">Save</button>
            <button class="btn ghost" data-action="cancel">Close</button>
          </div>
        </div>
        <div class="body" id="db_items_body">
          <table id="db_items_tbl">
            <thead><tr><th>Item</th><th>Market</th><th class="td-actions">Actions</th></tr></thead>
            <tbody><tr><td colspan="3" class="muted">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h3>Retailers <span id="db_retail_count" class="tag"></span></h3>
          <div class="btns">
            <button class="btn" data-action="edit">Edit</button>
            <button class="btn" data-action="add">Add</button>
            <button class="btn" data-action="save" style="display:none;">Save</button>
            <button class="btn ghost" data-action="cancel">Close</button>
          </div>
        </div>
        <div class="body" id="db_retail_body">
          <table id="db_retail_tbl">
            <thead><tr><th>Retailer</th><th class="td-actions">Actions</th></tr></thead>
            <tbody><tr><td colspan="2" class="muted">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h3>Marketplaces <span id="db_mkt_count" class="tag"></span></h3>
          <div class="btns">
            <button class="btn" data-action="edit">Edit</button>
            <button class="btn" data-action="add">Add</button>
            <button class="btn" data-action="save" style="display:none;">Save</button>
            <button class="btn ghost" data-action="cancel">Close</button>
          </div>
        </div>
        <div class="body" id="db_mkt_body">
          <table id="db_mkt_tbl">
            <thead><tr><th>Marketplace</th><th>Fee (decimal, e.g. 0.13)</th><th class="td-actions">Actions</th></tr></thead>
            <tbody><tr><td colspan="3" class="muted">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h3>Order Book <span id="db_sheet_count" class="tag"></span></h3>
          <div class="btns">
            <button class="btn" data-action="edit">Edit</button>
            <button class="btn" data-action="add">Add</button>
            <button class="btn" data-action="save" style="display:none;">Save</button>
            <button class="btn ghost" data-action="cancel">Close</button>
          </div>
        </div>
        <div class="body" id="db_sheet_body">
          <div class="pill muted">Newest first. Use inline Save per row.</div>
          <table id="db_sheet_tbl">
            <thead>
              <tr>
                <th>Order Date</th><th>Item</th><th>Buy Price</th><th>Bought From</th>
                <th>Sell Price</th><th>Sale Date</th><th>Sale Location</th><th>Shipping</th><th class="td-actions">Actions</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="9" class="muted">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Profiles -->
    <section id="tab_profiles" class="tabpane hide">
      <div class="card">
        <div class="hd">
          <h3>Profiles</h3>
          <div class="btns">
            <label class="btn">
              Import <input id="profiles_import_input" type="file" accept="application/json" style="display:none;">
            </label>
            <button id="profiles_export_btn" class="btn">Export</button>
          </div>
        </div>
        <div class="body show">
          <div class="row">
            <div class="col">
              <div class="card">
                <div class="hd"><h3>Add Profile</h3></div>
                <div class="body show">
                  <div class="row">
                    <div class="col"><label>Username<input id="pro_username" placeholder="jdoe"/></label></div>
                    <div class="col"><label>Email<input id="pro_email" placeholder="jdoe@email.com"/></label></div>
                  </div>
                  <div class="row">
                    <div class="col"><label>Discord<input id="pro_discord" placeholder="discord#1234"/></label></div>
                    <div class="col"><label>Role<input id="pro_role" placeholder="admin"/></label></div>
                  </div>
                  <div class="row">
                    <div class="col"><label>Notes<textarea id="pro_notes" rows="2" placeholder="notesâ€¦"></textarea></label></div>
                  </div>
                  <div class="row">
                    <div class="col"><button id="pro_add_btn" class="btn accent">Add Profile</button></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="hd"><h3>Profiles Table</h3>
                  <div class="btns">
                    <button id="pro_save_btn" class="btn">Save Edits</button>
                  </div>
                </div>
                <div class="body show">
                  <table id="pro_tbl">
                    <thead><tr>
                      <th>Username</th><th>Email</th><th>Discord</th><th>Role</th><th>Notes</th><th class="td-actions">Actions</th>
                    </tr></thead>
                    <tbody><tr><td colspan="6" class="muted">Loadingâ€¦</td></tr></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast"></div>

<script>
// ------------------ Shared UI utils ------------------
function $(sel, root=document){ return root.querySelector(sel); }
function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
function escapeHtml(s=''){
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function toast(msg){
  const el = document.getElementById('toast');
  el.textContent = String(msg||'');
  el.style.display='block';
  clearTimeout(window.__toastTO);
  window.__toastTO = setTimeout(()=>{ el.style.display='none'; }, 2500);
}
function showApp(){ document.getElementById('app').style.display='block'; document.getElementById('gate').style.display='none'; }
function showGate(){ document.getElementById('app').style.display='none'; document.getElementById('gate').style.display='block'; }

// Tabs
$all('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $all('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    $all('.tabpane').forEach(p=>p.classList.add('hide'));
    document.getElementById('tab_'+tab).classList.remove('hide');
    if (tab==='profiles') renderProfiles();
    if (tab==='database') loadDatabase();
  });
});

// Wire "Edit/Add/Save/Close" for each database card
function wireDBButtons(){
  const sections = [
    { body:'#db_items_body', tbl:'#db_items_tbl', section:'items' },
    { body:'#db_retail_body', tbl:'#db_retail_tbl', section:'retailers' },
    { body:'#db_mkt_body',    tbl:'#db_mkt_tbl',    section:'marketplaces' },
    { body:'#db_sheet_body',  tbl:'#db_sheet_tbl',  section:'sheet' },
  ];
  sections.forEach(({body, tbl, section})=>{
    const card = document.querySelector(body)?.closest('.card');
    if (!card) return;
    const edit = card.querySelector('[data-action="edit"]');
    const add  = card.querySelector('[data-action="add"]');
    const save = card.querySelector('[data-action="save"]');
    const cancel = card.querySelector('[data-action="cancel"]');

    // Only wire once
    if (card.__wired) return; card.__wired = true;

    edit?.addEventListener('click', ()=>{
      card.querySelector('.body')?.classList.add('show');
      edit.style.display='none';
      // Hide top Save for inline-save sections
      if (save) save.style.display = (['items','retailers','marketplaces','sheet'].includes(section) ? 'none' : '');
    });
    cancel?.addEventListener('click', ()=>{
      card.querySelector('.body')?.classList.remove('show');
      if (edit) edit.style.display='';
    });
    add?.addEventListener('click', ()=> insertPendingRow(section));
  });
}

// cell value getter
function cellVal(td){
  const el = td.querySelector('input, select, textarea');
  if (!el) return '';
  if (el.tagName==='SELECT') return el.value || '';
  if (el.type==='number') return (el.value!=='' ? Number(el.value) : 0);
  return el.value || '';
}

</script>

<script type="module">
// ------------------ Supabase Client ------------------
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

// ðŸ”§ Replace with your values
const SUPABASE_URL = 'https://dbxrlauvarqzvejvizew.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRieHJsYXV2YXJxenZlanZpemV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MzI5NjEsImV4cCI6MjA3MjMwODk2MX0.WxA5UxIxhV-fiac62xJ1B5blsJJ5S-1Vf1y3pQwxWiM';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window.supabase = supabase; // expose for legacy helpers

// ------------------ DB Helpers ------------------
const DB = {
  async list(table, columns='*', { orderBy, ascending=true, limit }={}){
    let q = supabase.from(table).select(columns);
    if (orderBy) q = q.order(orderBy, { ascending });
    if (limit) q = q.limit(limit);
    const { data, error } = await q;
    if (error) throw error;
    return data || [];
  },
  async insert(table, payload){
    const { data, error } = await supabase.from(table).insert(payload).select();
    if (error) throw error;
    return (data && data[0]) || null;
  },
  async update(table, id, payload, idCol='id'){
    const { data, error } = await supabase.from(table).update(payload).eq(idCol, id).select();
    if (error) throw error;
    return (data && data[0]) || null;
  },
  async remove(table, id, idCol='id'){
    const { error } = await supabase.from(table).delete().eq(idCol, id);
    if (error) throw error;
    return true;
  }
};

// ------------------ Auth / Gate ------------------
async function refreshGate(){
  const { data: { user } } = await supabase.auth.getUser();
  if (user){ try{ showApp(); }catch(_){} } else { try{ showGate(); }catch(_){} }
}
supabase.auth.onAuthStateChange(()=> refreshGate());

const discordBtn = document.getElementById('discordBtn');
const discordBtn2 = document.getElementById('discordBtn_clone');
[discordBtn, discordBtn2].forEach(btn=>{
  btn?.addEventListener('click', (e)=>{
    e.preventDefault();
    supabase.auth.signInWithOAuth({ provider:'discord', options:{ redirectTo: window.location.href } });
  });
});
document.getElementById('logoutBtn')?.addEventListener('click', async ()=>{
  await supabase.auth.signOut();
  location.reload();
});

// ------------------ Database Renderers ------------------
async function renderDBBody(section){
  try{
    if (section==='items'){
      const tb = document.querySelector('#db_items_tbl tbody');
      tb.innerHTML = '<tr><td colspan="3" class="muted">Loadingâ€¦</td></tr>';
      const rows = (await DB.list('Items','id, item_name, market', { orderBy:'item_name', ascending:true }))
        .map(r=>({ row:r.id, name:r.item_name||'', market:Number(r.market||0) }));
      document.getElementById('db_items_count').textContent = 'Rows: '+rows.length;
      tb.innerHTML = rows.map(x=>`
        <tr data-row="${x.row}">
          <td><input type="text" value="${escapeHtml(x.name)}"></td>
          <td><input type="number" step="0.01" value="${x.market}"></td>
          <td class="td-actions">
            <button class="btn db-row-update" type="button">Save</button>
            <button class="btn danger db-del" type="button">Delete</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="3" class="muted">No rows</td></tr>';

      tb.onclick = async (ev)=>{
        const tr = ev.target.closest('tr[data-row], tr.__pending');
        if (!tr) return;
        if (ev.target.matches('.db-row-update')){
          // pending -> insert, else update
          if (tr.classList.contains('__pending')){
            const name = cellVal(tr.children[0]).trim();
            const market = Number(cellVal(tr.children[1])||0);
            if (!name){ toast('Item name required'); return; }
            const rec = await DB.insert('Items',[{ item_name:name, market }]);
            toast('Item added'); renderDBBody('items');
          } else {
            const id = Number(tr.getAttribute('data-row'));
            const name = cellVal(tr.children[0]).trim();
            const market = Number(cellVal(tr.children[1])||0);
            await DB.update('Items', id, { item_name:name, market });
            tr.classList.add('saved'); setTimeout(()=>tr.classList.remove('saved'),600);
            toast('Item saved');
          }
        }
        if (ev.target.matches('.db-del')){
          const id = Number(tr.getAttribute('data-row'));
          if (!id || !confirm('Delete this item?')) return;
          await DB.remove('Items', id);
          tr.remove(); toast('Deleted');
          document.getElementById('db_items_count').textContent = 'Rows: '+document.querySelectorAll('#db_items_tbl tbody tr').length;
        }
        if (ev.target.matches('.db-row-cancel')){
          tr.remove();
        }
      };

      return;
    }

    if (section==='retailers'){
      const tb = document.querySelector('#db_retail_tbl tbody');
      tb.innerHTML = '<tr><td colspan="2" class="muted">Loadingâ€¦</td></tr>';
      const rows = (await DB.list('Retailers','id, name', { orderBy:'name', ascending:true }))
        .map(r=>({ row:r.id, name:r.name||'' }));
      document.getElementById('db_retail_count').textContent = 'Rows: '+rows.length;
      tb.innerHTML = rows.map(x=>`
        <tr data-row="${x.row}">
          <td><input type="text" value="${escapeHtml(x.name)}"></td>
          <td class="td-actions">
            <button class="btn db-row-update" type="button">Save</button>
            <button class="btn danger db-del" type="button">Delete</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="2" class="muted">No rows</td></tr>';

      tb.onclick = async (ev)=>{
        const tr = ev.target.closest('tr[data-row], tr.__pending');
        if (!tr) return;
        if (ev.target.matches('.db-row-update')){
          if (tr.classList.contains('__pending')){
            const name = cellVal(tr.children[0]).trim();
            if (!name){ toast('Name required'); return; }
            await DB.insert('Retailers',[{ name }]);
            toast('Retailer added'); renderDBBody('retailers');
          } else {
            const id = Number(tr.getAttribute('data-row'));
            const name = cellVal(tr.children[0]).trim();
            await DB.update('Retailers', id, { name });
            tr.classList.add('saved'); setTimeout(()=>tr.classList.remove('saved'),600);
            toast('Retailer saved');
          }
        }
        if (ev.target.matches('.db-del')){
          const id = Number(tr.getAttribute('data-row'));
          if (!id || !confirm('Delete this retailer?')) return;
          await DB.remove('Retailers', id);
          tr.remove(); toast('Deleted');
          document.getElementById('db_retail_count').textContent = 'Rows: '+document.querySelectorAll('#db_retail_tbl tbody tr').length;
        }
        if (ev.target.matches('.db-row-cancel')) tr.remove();
      };
      return;
    }

    if (section==='marketplaces'){
      const tb = document.querySelector('#db_mkt_tbl tbody');
      tb.innerHTML = '<tr><td colspan="3" class="muted">Loadingâ€¦</td></tr>';
      const rows = (await DB.list('Marketplaces','id, name, fee', { orderBy:'name', ascending:true }))
        .map(r=>({ row:r.id, name:r.name||'', fee:Number(r.fee||0) }));
      document.getElementById('db_mkt_count').textContent = 'Rows: '+rows.length;
      tb.innerHTML = rows.map(x=>`
        <tr data-row="${x.row}">
          <td><input type="text" value="${escapeHtml(x.name)}"></td>
          <td><input type="number" step="0.0001" value="${x.fee}"></td>
          <td class="td-actions">
            <button class="btn db-row-update" type="button">Save</button>
            <button class="btn danger db-del" type="button">Delete</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="3" class="muted">No rows</td></tr>';

      tb.onclick = async (ev)=>{
        const tr = ev.target.closest('tr[data-row], tr.__pending');
        if (!tr) return;
        if (ev.target.matches('.db-row-update')){
          if (tr.classList.contains('__pending')){
            const name = cellVal(tr.children[0]).trim();
            const fee  = Number(cellVal(tr.children[1])||0);
            if (!name){ toast('Name required'); return; }
            await DB.insert('Marketplaces',[{ name, fee }]);
            toast('Marketplace added'); renderDBBody('marketplaces');
          } else {
            const id = Number(tr.getAttribute('data-row'));
            const name = cellVal(tr.children[0]).trim();
            const fee  = Number(cellVal(tr.children[1])||0);
            await DB.update('Marketplaces', id, { name, fee });
            tr.classList.add('saved'); setTimeout(()=>tr.classList.remove('saved'),600);
            toast('Marketplace saved');
          }
        }
        if (ev.target.matches('.db-del')){
          const id = Number(tr.getAttribute('data-row'));
          if (!id || !confirm('Delete this marketplace?')) return;
          await DB.remove('Marketplaces', id);
          tr.remove(); toast('Deleted');
          document.getElementById('db_mkt_count').textContent = 'Rows: '+document.querySelectorAll('#db_mkt_tbl tbody tr').length;
        }
        if (ev.target.matches('.db-row-cancel')) tr.remove();
      };
      return;
    }

    if (section==='sheet'){
      const tb = document.querySelector('#db_sheet_tbl tbody');
      tb.innerHTML = '<tr><td colspan="9" class="muted">Loadingâ€¦</td></tr>';
      const { data: dataRows, error } = await supabase
        .from('Orders')
        .select('id, order_date, item, buy_price, bought_from, sell_price, sale_date, sale_location, shipping')
        .order('order_date', { ascending: false })
        .limit(500);
      if (error) throw error;

      const rows = (dataRows || []).map(r => ({
        row: r.id,
        order_date: r.order_date, item: r.item, buy_price: r.buy_price, bought_from: r.bought_from,
        sell_price: r.sell_price, sale_date: r.sale_date, sale_location: r.sale_location, shipping: r.shipping
      }));

      // Sort newest by order_date, then id desc
      rows.sort((a,b)=>{
        const da = a.order_date || ''; const db = b.order_date || '';
        if (da && db){ const cmp = db.localeCompare(da); if (cmp!==0) return cmp; }
        else if (da || db){ return db ? 1 : -1; }
        return (b.row||0)-(a.row||0);
      });

      document.getElementById('db_sheet_count').textContent = 'Rows: '+rows.length;

      // sale locations select options
      const mktNames = (await DB.list('Marketplaces','name', { orderBy:'name', ascending:true })).map(x=>x.name).filter(Boolean);
      const mktOptions = mktNames.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('');

      tb.innerHTML = rows.map(r=>`
        <tr data-row="${r.row}">
          <td><input type="date" value="${escapeHtml(r.order_date||'')}"></td>
          <td><input list="items" value="${escapeHtml(r.item||'')}"></td>
          <td><input type="number" step="0.01" value="${Number(r.buy_price||0)}"></td>
          <td><input list="retailers" value="${escapeHtml(r.bought_from||'')}"></td>
          <td><input type="number" step="0.01" value="${Number(r.sell_price||0)}"></td>
          <td><input type="date" value="${escapeHtml(r.sale_date||'')}"></td>
          <td><select>${mktOptions}</select></td>
          <td><input type="number" step="0.01" value="${Number(r.shipping||0)}"></td>
          <td class="td-actions">
            <button class="btn db-row-update" type="button">Save</button>
            <button class="btn danger db-del" type="button">Delete</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="9" class="muted">No rows</td></tr>';

      // restore selected value post render
      Array.from(tb.querySelectorAll('tr')).forEach((tr, i)=>{
        const sel = tr.children[6]?.querySelector('select'); if (sel) sel.value = rows[i]?.sale_location || '';
      });

      tb.onclick = async (ev)=>{
        const tr = ev.target.closest('tr[data-row], tr.__pending');
        if (!tr) return;
        if (ev.target.matches('.db-row-update')){
          if (tr.classList.contains('__pending')){
            // insert
            const rec = {
              order_date: cellVal(tr.children[0]) || null,
              item: cellVal(tr.children[1]) || null,
              buy_price: cellVal(tr.children[2]) ?? null,
              bought_from: cellVal(tr.children[3]) || null,
              sell_price: cellVal(tr.children[4]) ?? null,
              sale_date: cellVal(tr.children[5]) || null,
              sale_location: cellVal(tr.children[6]) || null,
              shipping: cellVal(tr.children[7]) ?? null
            };
            await DB.insert('Orders',[rec]);
            toast('Order added'); renderDBBody('sheet');
          } else {
            // update existing
            const id = Number(tr.getAttribute('data-row'));
            const rec = {
              order_date: cellVal(tr.children[0]) || null,
              item: cellVal(tr.children[1]) || null,
              buy_price: cellVal(tr.children[2]) ?? null,
              bought_from: cellVal(tr.children[3]) || null,
              sell_price: cellVal(tr.children[4]) ?? null,
              sale_date: cellVal(tr.children[5]) || null,
              sale_location: cellVal(tr.children[6]) || null,
              shipping: cellVal(tr.children[7]) ?? null
            };
            await DB.update('Orders', id, rec);
            tr.classList.add('saved'); setTimeout(()=>tr.classList.remove('saved'),600);
            toast('Order saved');
          }
        }
        if (ev.target.matches('.db-del')){
          const id = Number(tr.getAttribute('data-row'));
          if (!id || !confirm('Delete this order row?')) return;
          await DB.remove('Orders', id);
          tr.remove(); toast('Deleted');
          document.getElementById('db_sheet_count').textContent = 'Rows: '+document.querySelectorAll('#db_sheet_tbl tbody tr').length;
        }
        if (ev.target.matches('.db-row-cancel')) tr.remove();
      };

      return;
    }
  }catch(err){
    console.error(err);
    toast((err && err.message) || 'Load failed');
  }
}

// Insert a pending row at top for inline add
async function insertPendingRow(section){
  if (section==='items'){
    const tb = document.querySelector('#db_items_tbl tbody');
    const tr = document.createElement('tr');
    tr.className='__pending';
    tr.innerHTML = `
      <td><input type="text" value=""></td>
      <td><input type="number" step="0.01" value="0"></td>
      <td class="td-actions">
        <button class="btn db-row-update" type="button">Save</button>
        <button class="btn ghost db-row-cancel" type="button">Cancel</button>
      </td>`;
    tb.prepend(tr);
    tr.querySelector('input')?.focus();
    return;
  }
  if (section==='retailers'){
    const tb = document.querySelector('#db_retail_tbl tbody');
    const tr = document.createElement('tr');
    tr.className='__pending';
    tr.innerHTML = `
      <td><input type="text" value=""></td>
      <td class="td-actions">
        <button class="btn db-row-update" type="button">Save</button>
        <button class="btn ghost db-row-cancel" type="button">Cancel</button>
      </td>`;
    tb.prepend(tr);
    tr.querySelector('input')?.focus();
    return;
  }
  if (section==='marketplaces'){
    const tb = document.querySelector('#db_mkt_tbl tbody');
    const tr = document.createElement('tr');
    tr.className='__pending';
    tr.innerHTML = `
      <td><input type="text" value=""></td>
      <td><input type="number" step="0.0001" value="0"></td>
      <td class="td-actions">
        <button class="btn db-row-update" type="button">Save</button>
        <button class="btn ghost db-row-cancel" type="button">Cancel</button>
      </td>`;
    tb.prepend(tr);
    tr.querySelector('input')?.focus();
    return;
  }
  if (section==='sheet'){
    const tb = document.querySelector('#db_sheet_tbl tbody');
    const tr = document.createElement('tr');
    tr.className='__pending';
    // get marketplaces to build options
    const mktNames = (await DB.list('Marketplaces','name', { orderBy:'name', ascending:true })).map(x=>x.name).filter(Boolean);
    const mktOptions = mktNames.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('');
    tr.innerHTML = `
      <td><input type="date" value=""></td>
      <td><input list="items" value=""></td>
      <td><input type="number" step="0.01" value="0"></td>
      <td><input list="retailers" value=""></td>
      <td><input type="number" step="0.01" value="0"></td>
      <td><input type="date" value=""></td>
      <td><select>${mktOptions}</select></td>
      <td><input type="number" step="0.01" value="0"></td>
      <td class="td-actions">
        <button class="btn db-row-update" type="button">Save</button>
        <button class="btn ghost db-row-cancel" type="button">Cancel</button>
      </td>`;
    tb.prepend(tr);
    tr.querySelector('input,select')?.focus();
    return;
  }
}

// Load all db bodies initially when landing on database tab
async function loadDatabase(){
  await renderDBBody('items');
  await renderDBBody('retailers');
  await renderDBBody('marketplaces');
  await renderDBBody('sheet');
}
window.loadDatabase = loadDatabase;

// ------------------ Profiles ------------------
async function getProfiles(){
  const { data, error } = await supabase
    .from('Profiles')
    .select('id, "profileName", username, email, discord, role, notes, created, updated, created_at, updated_at')
    .order('profileName', { ascending:true });
  if (error) throw error;
  return (data||[]).map(row=>({
    id: row.id, row: row.id,
    username: row.username ?? row.profileName ?? '',
    email: row.email ?? '',
    discord: row.discord ?? '',
    role: row.role ?? '',
    notes: row.notes ?? '',
    created: row.created ?? row.created_at ?? null,
    updated: row.updated ?? row.updated_at ?? null
  }));
}
async function addProfile(payload){
  const rec = {
    username: payload?.username ?? '',
    email:    payload?.email    ?? '',
    discord:  payload?.discord  ?? '',
    role:     payload?.role     ?? '',
    notes:    payload?.notes    ?? ''
  };
  const { data, error } = await supabase.from('Profiles').insert([rec]).select('id');
  if (error) throw error;
  return { ok:true, id: data?.[0]?.id };
}
async function updateProfiles(rows){
  const updates = (rows||[]).map(r=>({
    id: r.row,
    username: r.username ?? null,
    email:    r.email ?? null,
    discord:  r.discord ?? null,
    role:     r.role ?? null,
    notes:    r.notes ?? null
  }));
  const { error } = await supabase.from('Profiles').upsert(updates, { onConflict:'id' });
  if (error) throw error;
  return { ok:true };
}
async function removeProfile(row){
  const id = Number(row);
  const { error } = await supabase.from('Profiles').delete().eq('id', id);
  if (error) throw error;
  return { ok:true };
}
window.apiGetProfiles = getProfiles;
window.apiAddProfile = addProfile;
window.apiUpdateProfiles = updateProfiles;
window.apiRemoveProfile = removeProfile;

function collectProfileEdits(){
  const out = [];
  document.querySelectorAll('#pro_tbl tbody tr[data-row]').forEach(tr=>{
    const row = Number(tr.getAttribute('data-row'));
    out.push({
      row,
      username: cellVal(tr.children[0]).trim(),
      email: cellVal(tr.children[1]).trim(),
      discord: cellVal(tr.children[2]).trim(),
      role: cellVal(tr.children[3]).trim(),
      notes: cellVal(tr.children[4]).trim()
    });
  });
  return out;
}

async function renderProfiles(){
  const tb = document.querySelector('#pro_tbl tbody');
  tb.innerHTML = '<tr><td colspan="6" class="muted">Loadingâ€¦</td></tr>';
  try{
    const rows = await getProfiles();
    tb.innerHTML = rows.map(r=>`
      <tr data-row="${r.row}">
        <td><input type="text" value="${escapeHtml(r.username||'')}"></td>
        <td><input type="text" value="${escapeHtml(r.email||'')}"></td>
        <td><input type="text" value="${escapeHtml(r.discord||'')}"></td>
        <td><input type="text" value="${escapeHtml(r.role||'')}"></td>
        <td><input type="text" value="${escapeHtml(r.notes||'')}"></td>
        <td class="td-actions">
          <button class="btn" data-act="del" data-row="${r.row}" type="button">Delete</button>
        </td>
      </tr>
    `).join('') || '<tr><td colspan="6" class="muted">No profiles</td></tr>';
  }catch(err){
    console.error(err);
    tb.innerHTML = '<tr><td colspan="6">Error loading profiles</td></tr>';
  }
}
window.renderProfiles = renderProfiles;

// add profile
document.getElementById('pro_add_btn')?.addEventListener('click', ()=>{
  const payload = {
    username: document.getElementById('pro_username').value.trim(),
    email:    document.getElementById('pro_email').value.trim(),
    discord:  document.getElementById('pro_discord').value.trim(),
    role:     document.getElementById('pro_role').value.trim(),
    notes:    document.getElementById('pro_notes').value.trim()
  };
  (async()=>{
    try{
      await (window.apiAddProfile? apiAddProfile(payload) : addProfile(payload));
      ['pro_username','pro_email','pro_discord','pro_role','pro_notes'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=''; });
      renderProfiles(); toast('Profile added');
    }catch(err){
      toast((err && err.message) || 'Add failed');
    }
  })();
});

// save edited profiles
document.getElementById('pro_save_btn')?.addEventListener('click', ()=>{
  const rows = collectProfileEdits();
  (async()=>{
    try{
      await (window.apiUpdateProfiles? apiUpdateProfiles(rows) : updateProfiles(rows));
      renderProfiles(); toast('Saved');
    }catch(err){
      toast((err && err.message) || 'Save failed');
    }
  })();
});

// delete profile (row button)
document.querySelector('#pro_tbl tbody')?.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act="del"]');
  if (!btn) return;
  const row = Number(btn.getAttribute('data-row'));
  if (!row || !confirm('Delete this profile row?')) return;
  (async()=>{
    try{
      await (window.apiRemoveProfile? apiRemoveProfile(row) : removeProfile(row));
      renderProfiles(); toast('Deleted');
    }catch(err){
      toast((err && err.message) || 'Delete failed');
    }
  })();
});

// Small helper to trigger a download of JSON
function downloadJSON(filename, data){
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

// Import profiles
document.getElementById('profiles_import_input')?.addEventListener('change', (e) => {
  const file = e.target.files?.[0];
  if (!file) { e.target.value=''; return; }
  const reader = new FileReader();
  reader.onload = async (ev)=>{
    try{
      const text = String(ev.target?.result || '').trim();
      const json = JSON.parse(text);
      if (!Array.isArray(json)) throw new Error('JSON must be an array of profiles');
      try{
        for (const row of json){
          await (window.apiAddProfile ? apiAddProfile(row) : addProfile(row));
        }
        renderProfiles(); toast('Import complete'); e.target.value='';
      }catch(err){
        toast((err && err.message) || 'Import failed'); e.target.value='';
      }
    }catch(_){
      toast('Invalid JSON'); e.target.value='';
    }
  };
  reader.readAsText(file);
});

// Export profiles
document.getElementById('profiles_export_btn')?.addEventListener('click', async ()=>{
  try{
    const data = await (window.apiGetProfiles ? apiGetProfiles() : getProfiles());
    downloadJSON('profiles.json', data||[]);
    toast('Export ready');
  }catch(err){
    toast((err && err.message) || 'Export failed');
  }
});

// Initial wires
wireDBButtons();

// Load initial view
(async ()=>{
  await refreshGate();
  loadDatabase();
})();
</script>

<!-- Datalists for items & retailers (used in Order Book inputs) -->
<datalist id="items"></datalist>
<datalist id="retailers"></datalist>

<script type="module">
// Populate datalists for convenience
import { createClient as _createClient } from 'https://esm.sh/@supabase/supabase-js@2';
const supabase2 = _createClient('https://dbxrlauvarqzvejvizew.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRieHJsYXV2YXJxenZlanZpemV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MzI5NjEsImV4cCI6MjA3MjMwODk2MX0.WxA5UxIxhV-fiac62xJ1B5blsJJ5S-1Vf1y3pQwxWiM');
async function refreshDatalists(){
  const { data: items } = await supabase2.from('Items').select('item_name').order('item_name', { ascending:true });
  const { data: retailers } = await supabase2.from('Retailers').select('name').order('name', { ascending:true });
  const itemsEl = document.getElementById('items'); const retailersEl = document.getElementById('retailers');
  if (itemsEl) itemsEl.innerHTML = (items||[]).map(x=>`<option value="${escapeHtml(x.item_name||'')}">`).join('');
  if (retailersEl) retailersEl.innerHTML = (retailers||[]).map(x=>`<option value="${escapeHtml(x.name||'')}">`).join('');
}
refreshDatalists();
</script>

</body>
</html>
